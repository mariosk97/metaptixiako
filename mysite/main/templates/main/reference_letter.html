{% extends 'main/base.html' %}
{% block content %}
{% load crispy_forms_tags %}
<div class="container"> <!--class used for bootstrap-->
    <form id="form-container" method="POST" action=""> 
        {% csrf_token %}
        {{reference_letter_formset.management_form}}
        {% for form in reference_letter_formset %}
        {% if form.is_deleted.value %}
        <div class="reference_letter-form entire-form" style="display: none;"> <!-- used in case user has deleted the form and page refreshes because of validations errors -->
            {{form|crispy}}
        </div>
        {% else %}
        <div class="reference_letter-form entire-form">
            {{form|crispy}}
        </div>
        {% endif %}
        {% endfor %}

        
        <button id="add_reference_letter_form" type="button" class="btn btn-secondary">Add Reference Letter</button>

        <input type="submit" value="Next" class="btn btn-primary"/>
    </form>
</div>        

<script>
    let container = document.querySelector("#form-container")
    let referenceLetterForm = document.querySelectorAll(".reference_letter-form")
    let addReferenceLetterButton = document.querySelector("#add_reference_letter_form")
    let referenceLetterFormNum = referenceLetterForm.length-1
    let emptyReferenceLetterFormNum = referenceLetterFormNum
    let referenceLetterPrefix = "reference_letter"
    let totalReferenceLetterForms = document.querySelector("#id_reference_letter-TOTAL_FORMS")
    //first form is hidden so there is always an empty form to be copied by addForm if page is refreshed because of validation errors plus user has deleted all forms
    //only works for create because if user is trying to update, the first form might not be empty
    if (!(window.location.href.indexOf("update") > -1)) { //if url does not contain 'update', user is trying to create an application
        console.log("create")
        referenceLetterForm[0].style.display = 'none' 
    }  
    

    addReferenceLetterButton.addEventListener('click', (e) => {    
        referenceLetterFormNum = incrementFormNum(referenceLetterFormNum);
        console.log("referenceLetterFormNum: " + referenceLetterFormNum);
        addForm(e, referenceLetterForm, referenceLetterPrefix, referenceLetterFormNum, addReferenceLetterButton, emptyReferenceLetterFormNum, totalReferenceLetterForms); 
    });

    const incrementFormNum = (num) => ++num;

    function addForm(e, formType, prefix, formNum, buttonType, emptyFormNum, totalForms){
        e.preventDefault()

        let newForm = formType[emptyFormNum].cloneNode(true)
        let formRegex = RegExp(`${prefix}-(\\d){1}-`,'g')
        console.log(formRegex)

        //undergraduateFormNum++ //this works
        newForm.innerHTML = newForm.innerHTML.replace(formRegex, `${prefix}-${formNum}-`)
        newForm.style.display = 'block' //copied form is hidden
        console.log(newForm)
        container.insertBefore(newForm, buttonType)
            
        totalForms.setAttribute('value', `${formNum+1}`)
    }

    container.addEventListener('change', e => {
        hideForm(e)
    });

    function hideForm(e){
        if(e.target.checked && e.target.classList.contains("deleteCheckbox")){
            console.log("delete")
            //form = e.target.closest("div")
            form = e.target.closest(".entire-form")
            form.style.display = 'none'
        }
    }


</script>    

{% endblock %} 